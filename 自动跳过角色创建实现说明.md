# 自动跳过角色创建实现说明

## 一、实现功能

实现了完整的自动跳过角色创建流程，包括：

1. **Stage 0: 文化选择阶段（CultureStage）**
   - 自动选择 Vlandia 文化
   - 设置完成后自动调用 `NextStage()` 进入下一个阶段

2. **Stage 1: 捏脸阶段（FaceGeneratorStage）**
   - 直接调用 `NextStage()` 跳过，不进行任何操作

3. **Stage 2: 问卷阶段（NarrativeStage）**
   - 使用现有的自动选择逻辑
   - 自动选择第一个可用选项
   - 自动切换到下一个问卷菜单
   - 问卷结束后自动进入下一个阶段

4. **Stage 3-6: 其他阶段（BannerEditor, ClanNaming, Review, Options）**
   - 直接调用 `NextStage()` 跳过

## 二、核心实现

### 1. AutoSkipCurrentStage 方法

**位置：** `QuickStartCharCreationSkipper.cs` 第 1082-1161 行

**功能：**
- 检测当前 Stage 类型
- 根据 Stage 类型执行相应操作
- 每帧最多执行一个操作，加 cooldown 避免状态机不一致

**逻辑：**
```csharp
if (CultureStage) {
    // Phase 0: 设置文化
    // Phase 1: 调用 NextStage()
}
else if (FaceGeneratorStage) {
    // 直接调用 NextStage() 跳过
}
else if (NarrativeStage) {
    // 使用现有的自动选择逻辑
}
else {
    // 其他阶段：直接调用 NextStage() 跳过
}
```

### 2. TryInvokeNextStage 方法

**位置：** `QuickStartCharCreationSkipper.cs` 第 1164-1187 行

**功能：**
- 反射调用 `CharacterCreationManager.NextStage()` 方法
- 跳过当前阶段，进入下一个阶段

### 3. Tick 方法集成

**位置：** `QuickStartCharCreationSkipper.cs` 第 283-310 行

**功能：**
- 在 `Tick` 方法中检测角色创建状态
- 获取 `CharacterCreationManager`
- 调用 `AutoSkipCurrentStage` 自动跳过当前阶段

## 三、工作流程

```
用户点击"快速开始"按钮
  ↓
进入 CharacterCreationState
  ↓
Tick() 检测到角色创建状态
  ↓
获取 CharacterCreationManager
  ↓
AutoSkipCurrentStage(manager, dt)
  ↓
检测 CurrentStage 类型
  ↓
根据 Stage 类型执行操作：
  - CultureStage: 设置文化 → NextStage()
  - FaceGeneratorStage: NextStage()（跳过）
  - NarrativeStage: 自动选择选项 → 切换菜单 → NextStage()
  - 其他 Stage: NextStage()（跳过）
  ↓
所有阶段完成
  ↓
进入 MapState（大地图）
  ↓
发放启动资金（100,000 第纳尔）
```

## 四、关键特性

### 1. 每帧只做一步

- 每个操作之间都有 cooldown（0.1-0.2s）
- 避免同帧多步推进导致状态机不一致
- 这是避免 native crash 的关键

### 2. 阶段检测

- 通过 `CharacterCreationManager.CurrentStage` 检测当前阶段
- 根据阶段类型名称（`CultureStage`、`FaceGeneratorStage` 等）判断

### 3. 文化自动选择

- 优先选择 Vlandia 文化
- 使用 `CharacterCreationContent.SetSelectedCulture()` 方法
- 设置完成后等待 0.2s 再调用 `NextStage()`

### 4. 问卷自动完成

- 使用现有的 `RunOnCharCreationState` 逻辑
- 自动选择第一个可用选项
- 自动切换到下一个问卷菜单
- 问卷结束后自动进入下一个阶段

## 五、日志关键字

在 `rgl_log.txt` 或 `qs_runtime.log` 中搜索以下关键字：

| 关键字 | 说明 |
|--------|------|
| `Culture set` | 文化设置成功 |
| `Called NextStage()` | 调用了 NextStage() 方法 |
| `Skipped FaceGeneratorStage` | 跳过了捏脸阶段 |
| `Skipped {stageTypeName}` | 跳过了其他阶段 |
| `AutoSkipCurrentStage` | 自动跳过当前阶段 |

## 六、验证步骤

### 步骤 1：编译

```powershell
cd "D:\SteamLibrary\steamapps\common\Mount & Blade II Bannerlord\Modules\QuickStartMod"
msbuild QuickStartMod.csproj /p:Configuration=Release /p:Platform=x64
```

### 步骤 2：启动游戏并测试

1. 启动 Bannerlord
2. 点击 "QS MOD 快速开始" 按钮
3. **检查：是否自动选择 Vlandia 文化**
4. **检查：是否自动跳过捏脸阶段**
5. **检查：是否自动完成问卷**
6. **检查：是否自动跳过其他阶段**
7. **检查：是否进入大地图**
8. **检查：是否获得 100,000 第纳尔**

### 步骤 3：检查日志

在 `rgl_log.txt` 或 `qs_runtime.log` 中搜索：

```
Culture set
Called NextStage()
Skipped
```

**期望看到：**
```
[QuickStart] CharCreation: Culture set, will call NextStage() next frame
[QuickStart] CharCreation: Called NextStage()
[QuickStart] CharCreation: Skipped FaceGeneratorStage
[QuickStart] CharCreation: Skipped CharacterCreationBannerEditorStage
[QuickStart] CharCreation: Skipped CharacterCreationClanNamingStage
[QuickStart] CharCreation: Skipped CharacterCreationReviewStage
[QuickStart] CharCreation: Skipped CharacterCreationOptionsStage
```

## 七、注意事项

1. **每帧只做一步**：避免同帧多步推进导致状态机不一致
2. **Cooldown 机制**：每个操作之间都有延迟，确保状态机稳定
3. **阶段检测**：通过 `CurrentStage` 属性检测当前阶段
4. **错误处理**：所有操作都有异常捕获，避免崩溃

## 八、如果验证失败

### 问题 1：文化没有自动选择

**可能原因：**
- `TrySetCulture` 方法失败
- Vlandia 文化没有找到

**检查：**
- 查看日志中是否有 "Culture set" 消息
- 查看日志中是否有 "TrySetCulture" 相关的错误

### 问题 2：阶段没有自动跳过

**可能原因：**
- `CurrentStage` 属性获取失败
- `NextStage()` 方法调用失败

**检查：**
- 查看日志中是否有 "Called NextStage()" 消息
- 查看日志中是否有 "NextStage() FAILED" 错误

### 问题 3：问卷没有自动完成

**可能原因：**
- `StartNarrativeStage` Postfix 没有被触发
- `CurrentMenu` 为 null

**检查：**
- 查看日志中是否有 "BindManager" 消息
- 查看日志中是否有 "CurrentMenu is null" 错误

## 九、改动文件清单

| 文件 | 改动内容 |
|------|---------|
| `QuickStartMod/SubModule/QuickStartCharCreationSkipper.cs` | 添加 `AutoSkipCurrentStage` 方法 |
| `QuickStartMod/SubModule/QuickStartCharCreationSkipper.cs` | 添加 `TryInvokeNextStage` 方法 |
| `QuickStartMod/SubModule/QuickStartCharCreationSkipper.cs` | 修改 `Tick` 方法调用 `AutoSkipCurrentStage` |
| `QuickStartMod/SubModule/QuickStartCharCreationSkipper.cs` | 修改 `NarrativeStage` 处理逻辑 |

