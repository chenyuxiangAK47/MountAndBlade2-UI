# QuickStartMod 测试指南和问题总结

## 当前状态

### 已完成的步骤
1. ✅ 创建了独立的 QuickStartMod 模块
2. ✅ 编译生成了 QuickStartMod.dll
3. ✅ 配置了 SubModule.xml
4. ✅ 添加了详细的日志记录（静态构造函数 + OnSubModuleLoad）
5. ✅ 实现了 UIExtenderEx PrefabExtension（按钮 UI）
6. ✅ 实现了 ViewModelMixin（命令绑定）

### 问题现象
- **DLL 已加载**：日志显示 `Loading assembly: ..\..\Modules\QuickStartMod\bin\Win64_Shipping_Client\QuickStartMod.dll`
- **没有日志输出**：未找到 `QuickStartMod_Static.log` 或 `QuickStartMod_OnLoad.log`
- **按钮未显示**：主菜单中没有"快速开始"按钮

## 测试步骤

### 1. 检查日志文件位置
启动游戏后，检查以下位置的日志文件：

**位置 1：临时目录**
```
%TEMP%\QuickStartMod_Static.log
%TEMP%\QuickStartMod_OnLoad.log
```

**位置 2：游戏目录（备用）**
```
D:\SteamLibrary\steamapps\common\Mount & Blade II Bannerlord\QuickStartMod_Static.log
D:\SteamLibrary\steamapps\common\Mount & Blade II Bannerlord\QuickStartMod_OnLoad.log
```

### 2. 检查游戏日志
查看 `rgl_log_*.txt`，查找：
- `Loading assembly: ..\..\Modules\QuickStartMod\bin\Win64_Shipping_Client\QuickStartMod.dll`
- 任何关于 QuickStartMod 的错误信息

### 3. 检查游戏内消息
启动游戏后，查看是否有任何 `[QuickStartMod]` 开头的游戏内消息

## 如果测试失败 - 给 ChatGPT 的信息

### 问题描述
我正在开发一个 Bannerlord Mod（QuickStartMod），用于在主菜单添加"快速开始"按钮。DLL 已成功编译并加载，但是：
1. 没有看到任何日志输出（静态构造函数和 OnSubModuleLoad 都没有执行）
2. 主菜单中没有显示"快速开始"按钮

### 技术栈
- **游戏**：Mount & Blade II: Bannerlord v1.3.11.104956
- **框架**：Harmony + UIExtenderEx（从 Steam Workshop 安装）
- **.NET Framework**：4.8
- **编译工具**：MSBuild 16.11.6

### 代码结构

**SubModule.xml**
```xml
<SubModule>
    <Name value="QuickStartMod" />
    <DLLName value="QuickStartMod.dll" />
    <SubModuleClassType value="QuickStartMod.QuickStartSubModule" />
    <Tags>
        <Tag key="DedicatedServerType" value="none" />
    </Tags>
</SubModule>
```

**QuickStartSubModule.cs**（关键部分）
```csharp
public class QuickStartSubModule : MBSubModuleBase
{
    // 静态构造函数：在类加载时立即执行
    static QuickStartSubModule()
    {
        var tempLog = Path.Combine(Path.GetTempPath(), "QuickStartMod_Static.log");
        File.AppendAllText(tempLog, $"[{DateTime.Now}] 静态构造函数执行！\n");
    }

    protected override void OnSubModuleLoad()
    {
        var tempLog = Path.Combine(Path.GetTempPath(), "QuickStartMod_OnLoad.log");
        File.AppendAllText(tempLog, $"[{DateTime.Now}] OnSubModuleLoad 开始执行！\n");
        
        // UIExtenderEx 初始化
        _uiExtender = UIExtender.Create("QuickStartMod");
        _uiExtender.Register(typeof(QuickStartSubModule).Assembly);
        _uiExtender.Enable();
    }
}
```

**QuickStartUIExtension.cs**（PrefabExtension）
```csharp
[PrefabExtension("InitialScreen", "descendant::NavigatableListPanel[@Id='MenuItems']")]
internal class QuickStartMenuButtonExtension : PrefabExtensionInsertPatch
{
    public override InsertType Type => InsertType.Prepend;
    // ... XML 定义按钮 ...
}
```

**QuickStartViewModelMixin.cs**（ViewModelMixin）
```csharp
[ViewModelMixin("InitialMenuVM")]
public class QuickStartViewModelMixin : BaseViewModelMixin<ViewModel>
{
    [DataSourceMethod]
    public void ExecuteQuickStart()
    {
        // 启动新游戏逻辑
    }
}
```

### 日志信息
- **DLL 加载**：✅ 日志显示 DLL 已加载（`Loading assembly: ..\..\Modules\QuickStartMod\bin\Win64_Shipping_Client\QuickStartMod.dll`）
- **SubModule 加载**：✅ 日志显示 `Loading submodules...`（第502行）
- **静态构造函数**：❌ 没有日志文件（`%TEMP%\QuickStartMod_Static.log` 不存在）
- **OnSubModuleLoad**：❌ 没有日志文件（`%TEMP%\QuickStartMod_OnLoad.log` 不存在）
- **错误信息**：❌ 游戏日志中没有错误
- **反射测试**：❌ 使用 PowerShell 反射加载 DLL 时出现 `ReflectionTypeLoadException`，说明 DLL 有依赖问题

### 关键发现
**反射加载测试失败**：使用 PowerShell 尝试反射加载 DLL 时出现 `ReflectionTypeLoadException`：
```
使用"0"个参数调用"GetTypes"时发生异常:无法加载一个或多个请求的类型。有关更多信息，请使用 LoaderExceptions 属性。
```

这说明：
1. **DLL 有依赖问题**：虽然 DLL 文件存在，但某些依赖可能无法解析
2. **类无法被实例化**：因为依赖问题，`QuickStartSubModule` 类可能无法被加载
3. **游戏可能静默失败**：游戏加载了 DLL，但因为依赖问题无法实例化类，但没有抛出异常

### 可能的问题
1. **依赖加载顺序问题**：Harmony 和 UIExtenderEx 可能需要在 QuickStartMod 之前加载
2. **依赖路径问题**：编译时引用的 DLL 路径可能与运行时不同
3. **类未被实例化**：DLL 加载了，但因为依赖问题，类无法被实例化
4. **OnSubModuleLoad 未被调用**：因为类未被实例化，所以 OnSubModuleLoad 没有被调用
5. **静态构造函数未执行**：因为类未被加载，所以静态构造函数没有执行

### 需要帮助的问题
1. **为什么 DLL 加载了，但静态构造函数和 OnSubModuleLoad 都没有执行？**
   - 反射测试显示 `ReflectionTypeLoadException`，说明有依赖问题
   - 游戏可能加载了 DLL，但因为依赖问题无法实例化类

2. **如何解决 ReflectionTypeLoadException？**
   - 是否需要将 Harmony 和 UIExtenderEx 的 DLL 复制到 QuickStartMod 的 bin 目录？
   - 或者是否需要修改依赖加载顺序？

3. **Bannerlord 如何加载 SubModule 类？**
   - 游戏是在什么时候实例化 SubModule 类的？
   - 如果依赖有问题，游戏会如何处理？

4. **如何确认 SubModule 类是否被正确实例化？**
   - 是否有其他方式可以调试 Bannerlord Mod 的加载过程？

5. **UIExtenderEx 的 PrefabExtension 和 ViewModelMixin 是否需要特定的加载顺序？**
   - 是否需要在 UIExtenderEx 完全加载后才能注册？

## 文件位置

- **DLL**：`D:\SteamLibrary\steamapps\common\Mount & Blade II Bannerlord\Modules\QuickStartMod\bin\Win64_Shipping_Client\QuickStartMod.dll`
- **SubModule.xml**：`D:\SteamLibrary\steamapps\common\Mount & Blade II Bannerlord\Modules\QuickStartMod\SubModule.xml`
- **源代码**：`D:\SteamLibrary\steamapps\common\Mount & Blade II Bannerlord\Modules\QuickStartMod\SubModule\`

## 依赖模块

- Bannerlord.Harmony（Steam Workshop）
- Bannerlord.UIExtenderEx（Steam Workshop）
- Native, SandBoxCore, Sandbox, StoryMode, CustomBattle（官方模块）

