# 反编译结果与代码修正说明

## 反编译完成

已成功反编译 `TaleWorlds.CampaignSystem.dll` 并找到角色创建相关的真实类型和方法。

## 关键发现

### 1. 类型结构

```
CharacterCreationState (GameState)
  └─ CharacterCreationManager (属性)
      ├─ CharacterCreationContent (属性)
      │   ├─ SelectedCulture (CultureObject)
      │   └─ SetSelectedCulture(CultureObject, CharacterCreationManager)
      ├─ CurrentMenu (NarrativeMenu)
      ├─ GetSuitableNarrativeMenuOptions() → IEnumerable<NarrativeMenuOption>
      ├─ OnNarrativeMenuOptionSelected(NarrativeMenuOption)
      └─ TrySwitchToNextMenu() → bool
```

### 2. 命名空间

- `TaleWorlds.CampaignSystem.CharacterCreationContent` - 角色创建内容相关类
- `CharacterCreationState` - 角色创建状态（GameState）
- `CharacterCreationManager` - 角色创建管理器（核心类）
- `CharacterCreationContent` - 角色创建内容（包含文化、属性等）
- `NarrativeMenu` - 叙事菜单
- `NarrativeMenuOption` - 菜单选项

## 代码修正

### 修正前的问题

1. **错误的查找目标**：之前查找 `CharacterCreationContent`，但实际上应该查找 `CharacterCreationManager`
2. **错误的属性访问**：直接访问 `SelectedCulture` 属性，但它是 private setter
3. **错误的方法调用**：猜测的方法名可能不存在

### 修正后的实现

#### 1. `FindCharacterCreationManager()` 方法

**之前**：查找 `CharacterCreationContent` 属性/字段  
**现在**：查找 `CharacterCreationManager` 属性（根据反编译结果，这是 public 属性）

```csharp
PropertyInfo managerProp = stateType.GetProperty("CharacterCreationManager", BF);
```

#### 2. `TrySetCulture()` 方法

**之前**：直接设置 `SelectedCulture` 属性（private setter，会失败）  
**现在**：使用 `SetSelectedCulture(CultureObject, CharacterCreationManager)` 方法

```csharp
// 1) 通过 CharacterCreationContent.GetCultures() 获取所有文化
MethodInfo getCulturesMethod = contentType.GetMethod("GetCultures", BF);
object culturesObj = getCulturesMethod.Invoke(content, null);

// 2) 找到瓦兰迪亚文化后，使用 SetSelectedCulture() 设置
MethodInfo setCultureMethod = contentType.GetMethod("SetSelectedCulture", BF);
setCultureMethod.Invoke(content, new object[] { vlandiaCulture, manager });
```

#### 3. `TrySelectCurrentMenuOption()` 方法

**之前**：猜测菜单选项的属性和方法  
**现在**：使用 `GetSuitableNarrativeMenuOptions()` 和 `OnNarrativeMenuOptionSelected()`

```csharp
// 1) 获取可用选项
MethodInfo getOptionsMethod = managerType.GetMethod("GetSuitableNarrativeMenuOptions", BF);
object optionsObj = getOptionsMethod.Invoke(manager, null);

// 2) 选择第一个选项
MethodInfo selectMethod = managerType.GetMethod("OnNarrativeMenuOptionSelected", BF);
selectMethod.Invoke(manager, new object[] { firstOption });
```

#### 4. `TrySwitchToNextMenu()` 方法

**之前**：已经正确，使用 `TrySwitchToNextMenu()`  
**现在**：保持不变（已验证此方法存在）

## 下一步

1. **重新编译 mod**：
   ```powershell
   msbuild QuickStartMod.csproj /p:Configuration=Release /p:Platform=x64
   ```

2. **测试角色创建自动跳过**：
   - 点击 "QS MOD 快速开始" 按钮
   - 观察是否自动跳过角色创建流程
   - 检查 `qs_runtime.log` 文件中的日志

3. **如果还有问题**：
   - 查看 `qs_runtime.log` 中的详细日志
   - 检查是否有异常信息
   - 可能需要反编译更多 DLL（如 SandBox.dll）来查找其他相关类型

## 文件位置

- 反编译输出：`D:\Bannerlord_Decompiled\TaleWorlds.CampaignSystem\`
- 关键文件：
  - `CharacterCreationManager.cs`
  - `CharacterCreationContent.cs`
  - `CharacterCreationState.cs`
  - `NarrativeMenu.cs`
  - `NarrativeMenuOption.cs`

## 注意事项

1. **其他 DLL 未反编译**：目前只反编译了 `TaleWorlds.CampaignSystem.dll`，其他 DLL（如 SandBox.dll）可能包含额外的角色创建相关代码，但核心逻辑应该已经覆盖。

2. **API 可能变化**：如果游戏更新，这些类型和方法可能会变化，需要重新反编译。

3. **反射性能**：使用反射会有性能开销，但角色创建只在游戏开始时执行一次，影响可以忽略。

